# 企业微信消息发送功能集成计划

## 需求分析
当前端发送`/add_user`请求（有新用户加入时），向企业微信的指定应用发送消息，使得企业里对应的成员能够看到提醒。

## 实现方案
1. **添加企业微信消息发送函数**：创建一个新的函数来处理企业微信消息发送逻辑
2. **集成到现有路由**：在现有的`/add_user`路由处理函数中调用该功能
3. **不修改现有业务逻辑**：确保原有功能保持不变，仅在成功添加用户后触发消息发送

## 具体实现步骤

### 1. 导入必要的库
在`darkerserver.py`文件顶部添加`requests`库导入，用于发送HTTP请求到企业微信API。

### 2. 创建企业微信消息发送函数
在`MyHandler`类外部或内部添加一个函数，用于发送企业微信消息：
- 函数接收企业微信配置参数（agent_id, access_token, user_ids, corp_id等）
- 调用企业微信API发送文本消息
- 包含错误处理和日志记录

### 3. 在`/add_user`路由中集成
在`/add_user`路由处理函数中：
- 保留原有业务逻辑
- 在成功添加用户后，调用企业微信消息发送函数
- 发送的消息内容应包含新用户的相关信息

### 4. 配置参数处理
- 建议将企业微信配置参数（agent_id, access_token, user_ids, corp_id）作为配置项，方便后续修改
- 可以在函数内部预留配置接口，或从外部传入

## 代码实现细节

### 企业微信消息发送函数示例
```python
import requests

def send_wechat_message(agent_id, access_token, user_ids, content):
    """发送企业微信消息"""
    url = f"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token={access_token}"
    payload = {
        "touser": "|" .join(user_ids),  # 用户ID列表，用|分隔
        "msgtype": "text",
        "agentid": agent_id,
        "text": {
            "content": content
        },
        "safe": 0
    }
    
    try:
        response = requests.post(url, json=payload)
        result = response.json()
        if result.get("errcode") == 0:
            print("企业微信消息发送成功")
            logging.info("企业微信消息发送成功")
        else:
            print(f"企业微信消息发送失败: {result.get('errmsg')}")
            logging.error(f"企业微信消息发送失败: {result.get('errmsg')}")
    except Exception as e:
        print(f"发送企业微信消息时发生错误: {str(e)}")
        logging.error(f"发送企业微信消息时发生错误: {str(e)}")
```

### 在`/add_user`路由中调用
在现有的`/add_user`路由处理函数中添加：
```python
elif self.path == '/add_user':
    new_user = data.get('user')
    resulting = add_users(new_user)
    # 发送企业微信消息
    if resulting.get('success'):
        # 企业微信配置参数（建议从配置文件或环境变量中获取）
        agent_id = "your_agent_id"
        access_token = "your_access_token"
        user_ids = ["user1", "user2"]  # 接收消息的用户ID列表
        content = f"新用户已加入：{new_user.get('username', '未知用户')}"
        send_wechat_message(agent_id, access_token, user_ids, content)
    self._send_response({'success': True, 'output': resulting})
```

## 注意事项
1. **确保requests库已安装**：如果项目中没有requests库，需要先安装
2. **access_token管理**：企业微信的access_token有有效期（2小时），如果需要长期使用，建议实现access_token的自动刷新机制
3. **错误处理**：确保企业微信消息发送失败不会影响原有业务逻辑
4. **日志记录**：添加详细的日志记录，方便调试和监控
5. **配置安全**：建议将敏感配置参数（如access_token）存储在安全的位置，避免硬编码

## 测试建议
1. 测试新用户添加功能，确保原有业务逻辑正常
2. 测试企业微信消息发送功能，确保消息能够成功发送到指定用户
3. 测试错误情况，确保系统具有良好的容错能力

## 预期效果
当有新用户通过前端添加时，系统会：
1. 正常执行原有添加用户逻辑
2. 自动向企业微信指定应用发送包含新用户信息的消息
3. 企业微信中的指定成员会收到提醒消息
4. 原有业务逻辑不受影响

## 后续优化方向
1. 实现access_token的自动刷新机制
2. 添加配置文件支持，方便修改企业微信参数
3. 支持更多类型的企业微信消息（如卡片消息、图片消息等）
4. 添加消息模板功能，支持自定义消息格式